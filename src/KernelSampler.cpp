#include "main.h"
#include "KernelSampler.h"

#define USE_SSE2
#include "sse_mathfun.h"

//precomputed Mie phase (RGB channels) for cloud droplets
static const dfloat3 mied[] = {
	{3.0156250,2.7480469,1.8994141},{3.0156250,2.7480469,1.8984375},{3.0136719,2.7460938,1.8964844},{3.0078125,2.7402344,1.8935547},
	{2.9980469,2.7324219,1.8876953},{2.9882812,2.7226562,1.8808594},{2.9746094,2.7109375,1.8730469},{2.9589844,2.6953125,1.8623047},
	{2.9414062,2.6796875,1.8515625},{2.9199219,2.6601562,1.8388672},{2.8964844,2.6406250,1.8242188},{2.8730469,2.6171875,1.8085938},
	{2.8457031,2.5937500,1.7910156},{2.8164062,2.5664062,1.7734375},{2.7851562,2.5390625,1.7539062},{2.7519531,2.5078125,1.7324219},
	{2.7187500,2.4765625,1.7109375},{2.6816406,2.4433594,1.6884766},{2.6445312,2.4101562,1.6650391},{2.6054688,2.3750000,1.6406250},
	{2.5644531,2.3378906,1.6152344},{2.5234375,2.3007812,1.5888672},{2.4824219,2.2617188,1.5625000},{2.4375000,2.2226562,1.5351562},
	{2.3945312,2.1816406,1.5078125},{2.3496094,2.1406250,1.4794922},{2.3046875,2.0996094,1.4511719},{2.2597656,2.0585938,1.4218750},
	{2.2128906,2.0175781,1.3935547},{2.1621094,1.9785156,1.3662109},{2.1093750,1.9404297,1.3417969},{2.0585938,1.8974609,1.3173828},
	{2.0117188,1.8535156,1.2910156},{1.9667969,1.8095703,1.2646484},{1.9218750,1.7666016,1.2382812},{1.8750000,1.7246094,1.2128906},
	{1.8291016,1.6845703,1.1865234},{1.7832031,1.6455078,1.1611328},{1.7382812,1.6064453,1.1357422},{1.6953125,1.5683594,1.1103516},
	{1.6513672,1.5302734,1.0849609},{1.6093750,1.4941406,1.0605469},{1.5693359,1.4580078,1.0361328},{1.5312500,1.4228516,1.0126953},
	{1.4941406,1.3876953,0.9892578},{1.4570312,1.3544922,0.9653320},{1.4189453,1.3183594,0.9409180},{1.3828125,1.2851562,0.9199219},
	{1.3496094,1.2558594,0.9008789},{1.3183594,1.2285156,0.8818359},{1.2900391,1.2031250,0.8632812},{1.2646484,1.1796875,0.8457031},
	{1.2402344,1.1572266,0.8295898},{1.2167969,1.1357422,0.8149414},{1.1933594,1.1142578,0.8012695},{1.1718750,1.0947266,0.7875977},
	{1.1513672,1.0751953,0.7744141},{1.1308594,1.0566406,0.7617188},{1.1113281,1.0380859,0.7495117},{1.0937500,1.0205078,0.7377930},
	{1.0751953,1.0048828,0.7260742},{1.0576172,0.9897461,0.7153320},{1.0419922,0.9750977,0.7045898},{1.0273438,0.9609375,0.6943359},
	{1.0126953,0.9482422,0.6845703},{0.9995117,0.9360352,0.6762695},{0.9863281,0.9233398,0.6684570},{0.9741211,0.9121094,0.6606445},
	{0.9619141,0.9013672,0.6528320},{0.9501953,0.8906250,0.6455078},{0.9389648,0.8798828,0.6376953},{0.9272461,0.8691406,0.6303711},
	{0.9155273,0.8583984,0.6225586},{0.9033203,0.8471680,0.6142578},{0.8916016,0.8359375,0.6064453},{0.8793945,0.8242188,0.5986328},
	{0.8671875,0.8129883,0.5908203},{0.8554688,0.8022461,0.5830078},{0.8437500,0.7919922,0.5751953},{0.8320312,0.7817383,0.5678711},
	{0.8222656,0.7714844,0.5615234},{0.8134766,0.7622070,0.5556641},{0.8046875,0.7543945,0.5493164},{0.7963867,0.7480469,0.5434570},
	{0.7890625,0.7416992,0.5385742},{0.7822266,0.7348633,0.5346680},{0.7753906,0.7285156,0.5312500},{0.7695312,0.7231445,0.5263672},
	{0.7636719,0.7167969,0.5219727},{0.7573242,0.7099609,0.5180664},{0.7495117,0.7041016,0.5136719},{0.7416992,0.6982422,0.5083008},
	{0.7338867,0.6909180,0.5034180},{0.7265625,0.6821289,0.4987793},{0.7187500,0.6738281,0.4931641},{0.7099609,0.6669922,0.4868164},
	{0.7011719,0.6601562,0.4809570},{0.6928711,0.6518555,0.4758301},{0.6850586,0.6435547,0.4704590},{0.6772461,0.6367188,0.4645996},
	{0.6694336,0.6298828,0.4594727},{0.6621094,0.6225586,0.4553223},{0.6547852,0.6157227,0.4506836},{0.6484375,0.6098633,0.4458008},
	{0.6420898,0.6040039,0.4411621},{0.6357422,0.5976562,0.4375000},{0.6298828,0.5913086,0.4335938},{0.6235352,0.5859375,0.4294434},
	{0.6171875,0.5810547,0.4252930},{0.6113281,0.5751953,0.4208984},{0.6054688,0.5688477,0.4169922},{0.5991211,0.5629883,0.4130859},
	{0.5927734,0.5576172,0.4086914},{0.5864258,0.5522461,0.4045410},{0.5800781,0.5458984,0.4003906},{0.5737305,0.5400391,0.3959961},
	{0.5673828,0.5341797,0.3918457},{0.5610352,0.5283203,0.3874512},{0.5546875,0.5219727,0.3833008},{0.5488281,0.5161133,0.3793945},
	{0.5424805,0.5107422,0.3754883},{0.5366211,0.5058594,0.3710938},{0.5312500,0.5004883,0.3674316},{0.5258789,0.4951172,0.3640137},
	{0.5205078,0.4902344,0.3603516},{0.5151367,0.4855957,0.3564453},{0.5102539,0.4804688,0.3530273},{0.5048828,0.4753418,0.3496094},
	{0.4995117,0.4707031,0.3459473},{0.4943848,0.4660645,0.3422852},{0.4890137,0.4606934,0.3391113},{0.4838867,0.4555664,0.3356934},
	{0.4787598,0.4511719,0.3317871},{0.4736328,0.4458008,0.3283691},{0.4685059,0.4406738,0.3251953},{0.4633789,0.4362793,0.3215332},
	{0.4582520,0.4318848,0.3178711},{0.4536133,0.4270020,0.3149414},{0.4487305,0.4223633,0.3120117},{0.4438477,0.4182129,0.3085938},
	{0.4394531,0.4140625,0.3054199},{0.4350586,0.4094238,0.3024902},{0.4306641,0.4057617,0.2990723},{0.4260254,0.4018555,0.2958984},
	{0.4213867,0.3974609,0.2937012},{0.4169922,0.3933105,0.2907715},{0.4130859,0.3898926,0.2871094},{0.4089355,0.3854980,0.2841797},
	{0.4042969,0.3811035,0.2817383},{0.3996582,0.3774414,0.2785645},{0.3952637,0.3732910,0.2753906},{0.3908691,0.3688965,0.2727051},
	{0.3864746,0.3649902,0.2695312},{0.3820801,0.3608398,0.2661133},{0.3779297,0.3559570,0.2634277},{0.3732910,0.3515625,0.2602539},
	{0.3681641,0.3479004,0.2570801},{0.3632812,0.3437500,0.2541504},{0.3588867,0.3391113,0.2509766},{0.3549805,0.3347168,0.2475586},
	{0.3513184,0.3300781,0.2445068},{0.3471680,0.3259277,0.2415771},{0.3422852,0.3229980,0.2388916},{0.3374023,0.3198242,0.2365723},
	{0.3339844,0.3161621,0.2343750},{0.3315430,0.3125000,0.2316895},{0.3291016,0.3090820,0.2290039},{0.3266602,0.3059082,0.2266846},
	{0.3229980,0.3034668,0.2249756},{0.3186035,0.3015137,0.2235107},{0.3149414,0.2990723,0.2218018},{0.3127441,0.2956543,0.2196045},
	{0.3105469,0.2922363,0.2169189},{0.3078613,0.2893066,0.2142334},{0.3044434,0.2858887,0.2124023},{0.3002930,0.2827148,0.2106934},
	{0.2961426,0.2805176,0.2080078},{0.2924805,0.2770996,0.2053223},{0.2893066,0.2727051,0.2032471},{0.2856445,0.2692871,0.2004395},
	{0.2819824,0.2661133,0.1973877},{0.2783203,0.2622070,0.1950684},{0.2744141,0.2587891,0.1928711},{0.2707520,0.2563477,0.1901855},
	{0.2678223,0.2531738,0.1882324},{0.2648926,0.2500000,0.1865234},{0.2624512,0.2480469,0.1842041},{0.2600098,0.2453613,0.1822510},
	{0.2570801,0.2424316,0.1807861},{0.2539062,0.2403564,0.1787109},{0.2509766,0.2376709,0.1763916},{0.2482910,0.2343750,0.1746826},
	{0.2453613,0.2319336,0.1723633},{0.2424316,0.2293701,0.1700439},{0.2396240,0.2263184,0.1685791},{0.2365723,0.2237549,0.1667480},
	{0.2338867,0.2216797,0.1643066},{0.2313232,0.2188721,0.1624756},{0.2287598,0.2163086,0.1607666},{0.2261963,0.2137451,0.1590576},
	{0.2236328,0.2111816,0.1574707},{0.2210693,0.2092285,0.1553955},{0.2186279,0.2070312,0.1534424},{0.2163086,0.2042236,0.1522217},
	{0.2138672,0.2019043,0.1505127},{0.2114258,0.1999512,0.1485596},{0.2089844,0.1975098,0.1468506},{0.2064209,0.1951904,0.1451416},
	{0.2041016,0.1928711,0.1434326},{0.2016602,0.1903076,0.1419678},{0.1992188,0.1882324,0.1402588},{0.1968994,0.1862793,0.1384277},
	{0.1948242,0.1838379,0.1368408},{0.1925049,0.1816406,0.1353760},{0.1900635,0.1795654,0.1337891},{0.1879883,0.1773682,0.1324463},
	{0.1857910,0.1755371,0.1306152},{0.1837158,0.1735840,0.1290283},{0.1816406,0.1712646,0.1278076},{0.1795654,0.1691895,0.1264648},
	{0.1773682,0.1677246,0.1246948},{0.1752930,0.1657715,0.1232300},{0.1733398,0.1635742,0.1218872},{0.1713867,0.1616211,0.1204224},
	{0.1693115,0.1596680,0.1189575},{0.1671143,0.1578369,0.1175537},{0.1651611,0.1561279,0.1160278},{0.1633301,0.1541748,0.1146240},
	{0.1613770,0.1522217,0.1133423},{0.1594238,0.1503906,0.1119995},{0.1574707,0.1488037,0.1105957},{0.1556396,0.1472168,0.1091919},
	{0.1538086,0.1453857,0.1079712},{0.1520996,0.1434326,0.1068115},{0.1503906,0.1419678,0.1054077},{0.1485596,0.1403809,0.1040649},
	{0.1468506,0.1386719,0.1029663},{0.1448975,0.1370850,0.1018066},{0.1433105,0.1354980,0.1005859},{0.1417236,0.1337891,0.0993042},
	{0.1400146,0.1322021,0.0980835},{0.1381836,0.1307373,0.0969849},{0.1364746,0.1291504,0.0958252},{0.1348877,0.1275635,0.0947266},
	{0.1334229,0.1259766,0.0936890},{0.1318359,0.1245117,0.0925293},{0.1301270,0.1231689,0.0913696},{0.1286621,0.1215820,0.0902710},
	{0.1270752,0.1200562,0.0892944},{0.1253662,0.1185913,0.0883179},{0.1239014,0.1170654,0.0872192},{0.1224365,0.1157837,0.0859985},
	{0.1208496,0.1144409,0.0849609},{0.1193848,0.1127319,0.0842285},{0.1179810,0.1112671,0.0833130},{0.1163940,0.1102295,0.0820923},
	{0.1150513,0.1089478,0.0809937},{0.1137695,0.1072998,0.0802612},{0.1123047,0.1059570,0.0794678},{0.1108398,0.1049194,0.0784302},
	{0.1096191,0.1036987,0.0773926},{0.1083984,0.1023560,0.0764771},{0.1069946,0.1010132,0.0758057},{0.1055298,0.0997925,0.0750732},
	{0.1043701,0.0987549,0.0739136},{0.1032104,0.0975342,0.0729370},{0.1018677,0.0961914,0.0723877},{0.1005859,0.0950317,0.0715942},
	{0.0994263,0.0939331,0.0705566},{0.0982056,0.0928345,0.0697021},{0.0968018,0.0917358,0.0689697},{0.0957031,0.0905151,0.0681152},
	{0.0946655,0.0892334,0.0672607},{0.0934448,0.0881958,0.0664062},{0.0920410,0.0872803,0.0656738},{0.0909424,0.0860596,0.0648804},
	{0.0900879,0.0848389,0.0640259},{0.0888672,0.0838623,0.0632324},{0.0875244,0.0828857,0.0625610},{0.0864258,0.0819092,0.0617065},
	{0.0855103,0.0807495,0.0608521},{0.0844116,0.0797119,0.0602112},{0.0833130,0.0787354,0.0594788},{0.0823975,0.0778198,0.0586243},
	{0.0814209,0.0768433,0.0579529},{0.0802612,0.0759888,0.0573730},{0.0791626,0.0750732,0.0567627},{0.0783691,0.0741577,0.0559692},
	{0.0776367,0.0732422,0.0550842},{0.0766602,0.0723267,0.0544739},{0.0756226,0.0712891,0.0539856},{0.0746460,0.0704956,0.0532532},
	{0.0736084,0.0698853,0.0524597},{0.0725708,0.0689697,0.0519104},{0.0718384,0.0678711,0.0513000},{0.0711670,0.0669556,0.0505066},
	{0.0703125,0.0661621,0.0497742},{0.0692139,0.0654907,0.0492249},{0.0681763,0.0646973,0.0487366},{0.0673828,0.0638428,0.0481567},
	{0.0667114,0.0629883,0.0474243},{0.0659180,0.0622253,0.0467529},{0.0650635,0.0614624,0.0461731},{0.0642090,0.0606689,0.0456238},
	{0.0634155,0.0599060,0.0450745},{0.0625610,0.0592346,0.0445251},{0.0617676,0.0585022,0.0439148},{0.0610962,0.0576782,0.0433044},
	{0.0603333,0.0569153,0.0427551},{0.0594788,0.0562744,0.0422363},{0.0586853,0.0555420,0.0417175},{0.0580139,0.0547791,0.0411377},
	{0.0573425,0.0540771,0.0405579},{0.0565491,0.0533752,0.0401001},{0.0557861,0.0527649,0.0396423},{0.0551453,0.0521545,0.0390625},
	{0.0545654,0.0513916,0.0386047},{0.0538940,0.0507507,0.0382080},{0.0531921,0.0502625,0.0376587},{0.0525208,0.0496216,0.0371399},
	{0.0518188,0.0488892,0.0367126},{0.0511169,0.0482483,0.0361938},{0.0504456,0.0475464,0.0356750},{0.0497742,0.0469055,0.0351562},
	{0.0490417,0.0463562,0.0346985},{0.0484314,0.0456848,0.0343323},{0.0479126,0.0451050,0.0338745},{0.0473633,0.0445862,0.0334167},
	{0.0467529,0.0440674,0.0330505},{0.0461731,0.0434875,0.0326843},{0.0456238,0.0429382,0.0322571},{0.0450134,0.0424194,0.0317993},
	{0.0444336,0.0418701,0.0314026},{0.0438843,0.0413208,0.0309906},{0.0433350,0.0407410,0.0305634},{0.0427551,0.0402222,0.0301666},
	{0.0421753,0.0397034,0.0297699},{0.0416260,0.0391846,0.0293427},{0.0410767,0.0386658,0.0289764},{0.0405273,0.0381470,0.0286102},
	{0.0400696,0.0375977,0.0282135},{0.0395508,0.0371094,0.0278320},{0.0389709,0.0366821,0.0274811},{0.0384521,0.0362244,0.0271301},
	{0.0380249,0.0357056,0.0267792},{0.0375366,0.0352478,0.0263977},{0.0370483,0.0348206,0.0260162},{0.0365295,0.0343628,0.0256958},
	{0.0360413,0.0339050,0.0253754},{0.0355835,0.0334778,0.0250092},{0.0351562,0.0330200,0.0246582},{0.0347290,0.0325928,0.0243530},
	{0.0342407,0.0321655,0.0240631},{0.0338135,0.0317688,0.0237427},{0.0333862,0.0313721,0.0234070},{0.0329590,0.0309296,0.0231476},
	{0.0325317,0.0304871,0.0228577},{0.0321350,0.0301208,0.0224915},{0.0317078,0.0297394,0.0221863},{0.0312500,0.0293121,0.0219269},
	{0.0308380,0.0289307,0.0216217},{0.0304413,0.0285492,0.0213013},{0.0300140,0.0281830,0.0210266},{0.0296478,0.0277863,0.0207520},
	{0.0292969,0.0273895,0.0204620},{0.0289001,0.0270538,0.0201874},{0.0284271,0.0267487,0.0199585},{0.0280762,0.0263519,0.0197144},
	{0.0278168,0.0259399,0.0194244},{0.0274811,0.0256042,0.0191193},{0.0270233,0.0253296,0.0189056},{0.0266113,0.0249939,0.0186920},
	{0.0263367,0.0246124,0.0184174},{0.0260620,0.0242615,0.0181274},{0.0256653,0.0239868,0.0178833},{0.0252686,0.0236664,0.0176697},
	{0.0249786,0.0233307,0.0174103},{0.0246887,0.0230255,0.0171356},{0.0243225,0.0227356,0.0169373},{0.0239868,0.0224304,0.0167236},
	{0.0237122,0.0221252,0.0164642},{0.0234222,0.0218353,0.0162201},{0.0230865,0.0215607,0.0160065},{0.0227356,0.0212860,0.0158386},
	{0.0224609,0.0209808,0.0156174},{0.0222321,0.0206909,0.0153503},{0.0219574,0.0204315,0.0151215},{0.0215912,0.0201721,0.0149841},
	{0.0212860,0.0198975,0.0148163},{0.0210571,0.0196533,0.0145645},{0.0208130,0.0194092,0.0143356},{0.0205078,0.0191345,0.0141754},
	{0.0202484,0.0188599,0.0139999},{0.0199738,0.0186310,0.0137787},{0.0196838,0.0184021,0.0135803},{0.0194397,0.0181427,0.0133972},
	{0.0191956,0.0178986,0.0132065},{0.0189056,0.0176697,0.0130463},{0.0186462,0.0174408,0.0128784},{0.0184326,0.0172119,0.0126724},
	{0.0182037,0.0169678,0.0125046},{0.0179291,0.0167389,0.0123825},{0.0176849,0.0165253,0.0122223},{0.0175018,0.0163269,0.0120087},
	{0.0172577,0.0161133,0.0118637},{0.0169983,0.0158997,0.0117569},{0.0167999,0.0156860,0.0115814},{0.0166321,0.0154877,0.0113831},
	{0.0164032,0.0152893,0.0112610},{0.0161743,0.0151062,0.0111084},{0.0160065,0.0149078,0.0109253},{0.0158081,0.0147095,0.0107880},
	{0.0155792,0.0145340,0.0106735},{0.0153885,0.0143661,0.0104980},{0.0152130,0.0141678,0.0103302},{0.0149994,0.0139465,0.0102234},
	{0.0148087,0.0137558,0.0100708},{0.0146484,0.0135803,0.0098648},{0.0144348,0.0133820,0.0097351},{0.0141830,0.0131760,0.0096817},
	{0.0139771,0.0130081,0.0095444},{0.0138397,0.0128708,0.0093231},{0.0136948,0.0126724,0.0092010},{0.0135117,0.0124435,0.0091476},
	{0.0133362,0.0122986,0.0090332},{0.0131683,0.0122147,0.0088654},{0.0129929,0.0120697,0.0087662},{0.0128250,0.0118942,0.0086899},
	{0.0126877,0.0117340,0.0085754},{0.0125427,0.0115967,0.0084457},{0.0123901,0.0114517,0.0083313},{0.0122223,0.0113144,0.0082245},
	{0.0120468,0.0111771,0.0081253},{0.0118942,0.0110474,0.0080185},{0.0117493,0.0109100,0.0079041},{0.0116043,0.0107651,0.0078087},
	{0.0114594,0.0106277,0.0077057},{0.0113144,0.0105133,0.0075912},{0.0111771,0.0103989,0.0074921},{0.0110397,0.0102615,0.0074081},
	{0.0109024,0.0101395,0.0073242},{0.0107574,0.0100250,0.0072365},{0.0106354,0.0099030,0.0071373},{0.0105286,0.0097733,0.0070305},
	{0.0103912,0.0096512,0.0069427},{0.0102234,0.0095367,0.0068855},{0.0100861,0.0094070,0.0068054},{0.0100021,0.0092850,0.0066872},
	{0.0098953,0.0091629,0.0065804},{0.0097504,0.0090485,0.0065231},{0.0096054,0.0089340,0.0064659},{0.0094910,0.0088348,0.0063744},
	{0.0093994,0.0087204,0.0062752},{0.0093002,0.0085907,0.0061913},{0.0091858,0.0084839,0.0061264},{0.0090485,0.0083923,0.0060577},
	{0.0089417,0.0082932,0.0059891},{0.0088501,0.0081940,0.0059128},{0.0087585,0.0081100,0.0058212},{0.0086670,0.0080109,0.0057564},
	{0.0085678,0.0079041,0.0057068},{0.0084610,0.0078278,0.0056381},{0.0083694,0.0077553,0.0055466},{0.0082779,0.0076637,0.0054703},
	{0.0081863,0.0075645,0.0054092},{0.0080872,0.0074654,0.0053558},{0.0079956,0.0073853,0.0052834},{0.0078964,0.0073204,0.0052032},
	{0.0078011,0.0072441,0.0051460},{0.0077209,0.0071564,0.0050888},{0.0076561,0.0070686,0.0050240},{0.0075607,0.0069923,0.0049820},
	{0.0074577,0.0069275,0.0049400},{0.0073814,0.0068550,0.0048714},{0.0073128,0.0067825,0.0048027},{0.0072250,0.0066948,0.0047646},
	{0.0071373,0.0065994,0.0047302},{0.0070534,0.0065193,0.0046806},{0.0069695,0.0064507,0.0046272},{0.0068855,0.0063744,0.0045815},
	{0.0068130,0.0063057,0.0045357},{0.0067482,0.0062294,0.0044937},{0.0066872,0.0061493,0.0044594},{0.0066147,0.0060806,0.0044327},
	{0.0065231,0.0060425,0.0043945},{0.0064583,0.0059853,0.0043449},{0.0064316,0.0059013,0.0042877},{0.0063782,0.0058327,0.0042381},
	{0.0062714,0.0057869,0.0042114},{0.0061722,0.0057411,0.0041771},{0.0061188,0.0056877,0.0041122},{0.0060921,0.0056267,0.0040321},
	{0.0060387,0.0055618,0.0039902},{0.0059624,0.0055084,0.0039711},{0.0058937,0.0054741,0.0039368},{0.0058403,0.0054512,0.0038757},
	{0.0057831,0.0054131,0.0038338},{0.0057297,0.0053482,0.0038109},{0.0056992,0.0052795,0.0037708},{0.0056648,0.0052299,0.0037136},
	{0.0055885,0.0051994,0.0036850},{0.0054970,0.0051613,0.0036793},{0.0054436,0.0051041,0.0036583},{0.0054283,0.0050392,0.0036087},
	{0.0054054,0.0049820,0.0035629},{0.0053406,0.0049400,0.0035419},{0.0052681,0.0048981,0.0035343},{0.0052185,0.0048485,0.0035114},
	{0.0051804,0.0048027,0.0034771},{0.0051308,0.0047569,0.0034561},{0.0050926,0.0047112,0.0034256},{0.0050774,0.0046730,0.0033703},
	{0.0050392,0.0046349,0.0033398},{0.0049553,0.0046043,0.0033512},{0.0048904,0.0045738,0.0033493},{0.0048866,0.0045433,0.0032921},
	{0.0048866,0.0045204,0.0032234},{0.0048447,0.0044899,0.0032101},{0.0047836,0.0044441,0.0032196},{0.0047417,0.0044212,0.0031929},
	{0.0047073,0.0044174,0.0031376},{0.0046616,0.0043831,0.0031166},{0.0046234,0.0043335,0.0031052},{0.0046082,0.0042953,0.0030670},
	{0.0045891,0.0042648,0.0030270},{0.0045357,0.0042458,0.0030212},{0.0044746,0.0042305,0.0030231},{0.0044479,0.0042038,0.0030079},
	{0.0044479,0.0041618,0.0029812},{0.0044365,0.0041275,0.0029583},{0.0043983,0.0041046,0.0029488},{0.0043526,0.0040817,0.0029488},
	{0.0043182,0.0040512,0.0029373},{0.0042915,0.0040245,0.0029182},{0.0042686,0.0039864,0.0029068},{0.0042458,0.0039558,0.0028896},
	{0.0042229,0.0039406,0.0028629},{0.0041924,0.0039177,0.0028477},{0.0041618,0.0038834,0.0028553},{0.0041351,0.0038605,0.0028477},
	{0.0041199,0.0038548,0.0028114},{0.0041122,0.0038433,0.0027790},{0.0040932,0.0038166,0.0027733},{0.0040665,0.0037956,0.0027695},
	{0.0040436,0.0037804,0.0027561},{0.0040321,0.0037708,0.0027313},{0.0040169,0.0037613,0.0027084},{0.0039902,0.0037441,0.0027027},
	{0.0039749,0.0037193,0.0026970},{0.0039635,0.0037022,0.0026741},{0.0039406,0.0037022,0.0026512},{0.0039101,0.0036888,0.0026531},
	{0.0038948,0.0036545,0.0026569},{0.0038929,0.0036335,0.0026417},{0.0038738,0.0036297,0.0026226},{0.0038452,0.0036201,0.0026207},
	{0.0038261,0.0035992,0.0026245},{0.0038166,0.0035763,0.0026207},{0.0037994,0.0035648,0.0026131},{0.0037804,0.0035553,0.0026054},
	{0.0037727,0.0035381,0.0025978},{0.0037670,0.0035191,0.0025883},{0.0037518,0.0035076,0.0025826},{0.0037289,0.0035057,0.0025787},
	{0.0037117,0.0035019,0.0025711},{0.0037003,0.0034924,0.0025597},{0.0036945,0.0034866,0.0025444},{0.0036888,0.0034809,0.0025311},
	{0.0036869,0.0034657,0.0025234},{0.0036774,0.0034561,0.0025177},{0.0036564,0.0034618,0.0025101},{0.0036316,0.0034657,0.0025101},
	{0.0036240,0.0034523,0.0025082},{0.0036354,0.0034389,0.0024891},{0.0036507,0.0034256,0.0024662},{0.0036449,0.0034065,0.0024681},
	{0.0036182,0.0033951,0.0024872},{0.0035858,0.0034008,0.0024986},{0.0035744,0.0033989,0.0024967},{0.0035915,0.0033760,0.0024872},
	{0.0036125,0.0033531,0.0024738},{0.0036087,0.0033455,0.0024719},{0.0035763,0.0033417,0.0024872},{0.0035419,0.0033379,0.0025063},
	{0.0035248,0.0033340,0.0025043},{0.0035267,0.0033302,0.0024834},{0.0035305,0.0033188,0.0024662},{0.0035286,0.0033054,0.0024624},
	{0.0035114,0.0033016,0.0024643},{0.0034866,0.0033112,0.0024643},{0.0034733,0.0033169,0.0024605},{0.0034828,0.0033035,0.0024548},
	{0.0034981,0.0032825,0.0024509},{0.0035057,0.0032787,0.0024433},{0.0035019,0.0032825,0.0024338},{0.0034962,0.0032711,0.0024414},
	{0.0034943,0.0032501,0.0024548},{0.0034981,0.0032368,0.0024529},{0.0035057,0.0032253,0.0024471},{0.0035114,0.0032101,0.0024490},
	{0.0035095,0.0032120,0.0024414},{0.0035038,0.0032291,0.0024261},{0.0034943,0.0032310,0.0024261},{0.0034904,0.0032196,0.0024395},
	{0.0034904,0.0032253,0.0024338},{0.0034885,0.0032444,0.0024166},{0.0034828,0.0032597,0.0024109},{0.0034771,0.0032711,0.0024090},
	{0.0034714,0.0032845,0.0024071},{0.0034618,0.0032921,0.0024128},{0.0034542,0.0032978,0.0024204},{0.0034504,0.0033035,0.0024204},
	{0.0034428,0.0033016,0.0024395},{0.0034256,0.0032959,0.0024719},{0.0034237,0.0033035,0.0024834},{0.0034428,0.0033188,0.0024738},
	{0.0034542,0.0033283,0.0024796},{0.0034466,0.0033321,0.0025139},{0.0034428,0.0033321,0.0025501},{0.0034504,0.0033360,0.0025749},
	{0.0034580,0.0033531,0.0025883},{0.0034847,0.0033722,0.0025864},{0.0035286,0.0033836,0.0025826},{0.0035572,0.0033875,0.0026035},
	{0.0035686,0.0033894,0.0026455},{0.0035915,0.0034046,0.0026665},{0.0036297,0.0034332,0.0026665},{0.0036640,0.0034561,0.0026779},
	{0.0037022,0.0034599,0.0027084},{0.0037613,0.0034637,0.0027218},{0.0038242,0.0034962,0.0027065},{0.0038662,0.0035419,0.0027008},
	{0.0038948,0.0035706,0.0027275},{0.0039291,0.0035954,0.0027542},{0.0039787,0.0036316,0.0027599},{0.0040398,0.0036736,0.0027523},
	{0.0041008,0.0037193,0.0027485},{0.0041504,0.0037708,0.0027580},{0.0042000,0.0038147,0.0027847},{0.0042381,0.0038586,0.0028248},
	{0.0042763,0.0039139,0.0028667},{0.0043259,0.0039673,0.0028934},{0.0043716,0.0040245,0.0029202},{0.0044136,0.0040741,0.0029659},
	{0.0044518,0.0041084,0.0030251},{0.0044823,0.0041580,0.0030823},{0.0044975,0.0042381,0.0031319},{0.0045166,0.0043144,0.0031834},
	{0.0045662,0.0043488,0.0032482},{0.0046196,0.0043640,0.0033321},{0.0046387,0.0044289,0.0034027},{0.0046501,0.0045166,0.0034523},
	{0.0046959,0.0045662,0.0035133},{0.0047493,0.0045815,0.0035973},{0.0047874,0.0046043,0.0036907},{0.0048103,0.0046654,0.0037575},
	{0.0048523,0.0047379,0.0038013},{0.0049133,0.0047798,0.0038471},{0.0049744,0.0048103,0.0039043},{0.0050125,0.0048714,0.0039558},
	{0.0050507,0.0049438,0.0039978},{0.0051079,0.0050240,0.0040169},{0.0051842,0.0051041,0.0040169},{0.0052643,0.0051689,0.0040283},
	{0.0053368,0.0052414,0.0040474},{0.0053864,0.0053177,0.0040779},{0.0054626,0.0053596,0.0041122},{0.0055771,0.0054092,0.0041008},
	{0.0056686,0.0054855,0.0040817},{0.0057259,0.0055275,0.0041237},{0.0058098,0.0055199,0.0041809},{0.0059242,0.0055161,0.0042076},
	{0.0059891,0.0055428,0.0042419},{0.0060081,0.0055962,0.0042915},{0.0060577,0.0056458,0.0043182},{0.0061493,0.0056496,0.0043411},
	{0.0062256,0.0056190,0.0044060},{0.0062561,0.0056038,0.0044937},{0.0062485,0.0056572,0.0045433},{0.0062332,0.0057259,0.0045776},
	{0.0062523,0.0057144,0.0046425},{0.0063133,0.0056686,0.0047035},{0.0063553,0.0056572,0.0047417},{0.0063286,0.0056877,0.0048103},
	{0.0062714,0.0057335,0.0048866},{0.0062561,0.0057869,0.0049171},{0.0063057,0.0057983,0.0049171},{0.0063515,0.0057755,0.0049515},
	{0.0063057,0.0057907,0.0050316},{0.0062485,0.0058403,0.0050812},{0.0062561,0.0058784,0.0050659},{0.0062904,0.0058784,0.0050583},
	{0.0062904,0.0058670,0.0050926},{0.0062828,0.0058708,0.0051155},{0.0062752,0.0059013,0.0051041},{0.0062675,0.0059357,0.0050850},
	{0.0062714,0.0059433,0.0050735},{0.0062790,0.0059662,0.0050354},{0.0062752,0.0060081,0.0049896},{0.0062790,0.0060196,0.0049706},
	{0.0062904,0.0060272,0.0049438},{0.0062904,0.0060730,0.0048904},{0.0062752,0.0061150,0.0048561},{0.0062675,0.0061150,0.0048485},
	{0.0062866,0.0060997,0.0048256},{0.0063095,0.0060959,0.0047798},{0.0063057,0.0061188,0.0047264},{0.0062866,0.0061378,0.0046883},
	{0.0063019,0.0061264,0.0046425},{0.0063400,0.0061264,0.0045776},{0.0063591,0.0061455,0.0045128},{0.0063705,0.0061569,0.0044594},
	{0.0063896,0.0061798,0.0043945},{0.0064049,0.0062027,0.0043335},{0.0064201,0.0061913,0.0042953},{0.0064354,0.0061836,0.0042534},
	{0.0064392,0.0061913,0.0042076},{0.0064430,0.0061913,0.0041656},{0.0064507,0.0061874,0.0041275},{0.0064697,0.0061836,0.0040932},
	{0.0065002,0.0061913,0.0040321},{0.0065346,0.0062027,0.0039787},{0.0065575,0.0062141,0.0039368},{0.0065956,0.0062332,0.0038738},
	{0.0066490,0.0062332,0.0038185},{0.0066872,0.0062294,0.0037861},{0.0067139,0.0062447,0.0037537},{0.0067444,0.0062561,0.0037231},
	{0.0067787,0.0062523,0.0037117},{0.0068130,0.0062485,0.0037060},{0.0068550,0.0062523,0.0036983},{0.0068932,0.0062675,0.0036888},
	{0.0069313,0.0063019,0.0036755},{0.0069885,0.0063438,0.0036469},{0.0070648,0.0063782,0.0036259},{0.0071449,0.0064049,0.0036144},
	{0.0072174,0.0064316,0.0036297},{0.0072708,0.0064735,0.0036602},{0.0073433,0.0065460,0.0036583},{0.0074425,0.0066071,0.0036526},
	{0.0075493,0.0066261,0.0037003},{0.0076599,0.0066452,0.0037556},{0.0077667,0.0066948,0.0037994},{0.0078506,0.0067635,0.0038586},
	{0.0079498,0.0068398,0.0039177},{0.0080719,0.0069351,0.0039520},{0.0082092,0.0070457,0.0039825},{0.0083618,0.0071335,0.0040398},
	{0.0085449,0.0071945,0.0041237},{0.0087280,0.0072937,0.0042114},{0.0088730,0.0074806,0.0042763},{0.0090485,0.0076714,0.0043373},
	{0.0093079,0.0078011,0.0044098},{0.0096207,0.0078964,0.0044937},{0.0099182,0.0080185,0.0046005},{0.0102158,0.0081863,0.0046959},
	{0.0105286,0.0083923,0.0047760},{0.0108185,0.0086212,0.0048790},{0.0111465,0.0088654,0.0049706},{0.0115891,0.0090942,0.0050011},
	{0.0120773,0.0093079,0.0050430},{0.0124969,0.0095673,0.0051537},{0.0129013,0.0099030,0.0052490},{0.0134048,0.0102539,0.0052834},
	{0.0139465,0.0106201,0.0052986},{0.0144730,0.0109940,0.0053825},{0.0150528,0.0113220,0.0055084},{0.0157013,0.0116959,0.0055656},
	{0.0162964,0.0121918,0.0055962},{0.0167847,0.0127487,0.0057335},{0.0173187,0.0132599,0.0059357},{0.0179596,0.0137711,0.0060730},
	{0.0186310,0.0143127,0.0062027},{0.0192719,0.0148468,0.0064201},{0.0198822,0.0153885,0.0067291},{0.0203857,0.0160828,0.0070648},
	{0.0208588,0.0168457,0.0074043},{0.0214844,0.0175171,0.0077553},{0.0221558,0.0181427,0.0081482},{0.0227203,0.0188904,0.0086060},
	{0.0232391,0.0196838,0.0091019},{0.0238647,0.0204163,0.0096207},{0.0244904,0.0211334,0.0101852},{0.0250092,0.0219574,0.0108337},
	{0.0255127,0.0227509,0.0115356},{0.0260925,0.0234985,0.0122757},{0.0266724,0.0242615,0.0130386},{0.0272064,0.0250702,0.0138168},
	{0.0277557,0.0258636,0.0146408},{0.0283051,0.0266418,0.0155106},{0.0288544,0.0274353,0.0163879},{0.0294037,0.0282135,0.0173035},
	{0.0299835,0.0289154,0.0182953},{0.0305481,0.0296326,0.0192719},{0.0311127,0.0303955,0.0202179},{0.0316162,0.0310974,0.0212250},
	{0.0321350,0.0316772,0.0223083},{0.0326538,0.0322571,0.0233307},{0.0332031,0.0328674,0.0242767},{0.0337219,0.0333862,0.0252533},
	{0.0342102,0.0338440,0.0262604},{0.0346985,0.0343018,0.0271912},{0.0352478,0.0346985,0.0280609},{0.0357971,0.0350037,0.0289307},
	{0.0362854,0.0353699,0.0297394},{0.0368042,0.0356750,0.0304413},{0.0374146,0.0358887,0.0310516},{0.0379944,0.0360413,0.0315857},
	{0.0385132,0.0362244,0.0320129},{0.0390625,0.0364075,0.0322571},{0.0397339,0.0364990,0.0323486},{0.0403137,0.0364990,0.0324097},
	{0.0408020,0.0366211,0.0322876},{0.0413513,0.0368042,0.0318298},{0.0419617,0.0369263,0.0312195},{0.0423584,0.0370178,0.0306549},
	{0.0425110,0.0372314,0.0299988},{0.0423279,0.0376587,0.0292664},{0.0417480,0.0380249,0.0288239},{0.0409241,0.0381470,0.0287170},
	{0.0399780,0.0381165,0.0286865},{0.0387268,0.0379028,0.0289917},{0.0372620,0.0374451,0.0296021},{0.0361328,0.0368652,0.0298309},
	{0.0354004,0.0362854,0.0295563},{0.0345764,0.0355530,0.0293884},{0.0336914,0.0347290,0.0292358},{0.0331116,0.0339661,0.0286713},
	{0.0328064,0.0332031,0.0276794},{0.0323181,0.0325012,0.0267944},{0.0317688,0.0317688,0.0259705},{0.0314636,0.0310364,0.0248260},
	{0.0312805,0.0303192,0.0235138},{0.0308990,0.0295868,0.0224457},{0.0304718,0.0288391,0.0214386},{0.0301819,0.0280914,0.0203552},
	{0.0298157,0.0273438,0.0194092},{0.0292816,0.0265656,0.0187531},{0.0286865,0.0257568,0.0182495},{0.0279846,0.0249786,0.0179291},
	{0.0271606,0.0242004,0.0177917},{0.0264282,0.0234528,0.0176697},{0.0256500,0.0228119,0.0176239},{0.0246582,0.0223236,0.0177307},
	{0.0237274,0.0219269,0.0178375},{0.0230865,0.0215759,0.0177307},{0.0225372,0.0213013,0.0175781},{0.0219727,0.0211487,0.0174255},
	{0.0215759,0.0210114,0.0172119},{0.0213776,0.0208588,0.0169067},{0.0212708,0.0207672,0.0165710},{0.0211945,0.0207367,0.0162048},
	{0.0211182,0.0207062,0.0159454},{0.0211029,0.0205841,0.0157928},{0.0212250,0.0204315,0.0155945},{0.0213928,0.0203247,0.0153809},
	{0.0214081,0.0203094,0.0152740},{0.0213776,0.0202637,0.0152893},{0.0214539,0.0201569,0.0153122},{0.0215302,0.0200500,0.0153427},
	{0.0215302,0.0200500,0.0153885},{0.0214844,0.0200653,0.0154572},{0.0215149,0.0200348,0.0155029},{0.0215302,0.0200195,0.0155334},
	{0.0214844,0.0200500,0.0155869},{0.0214081,0.0200958,0.0156555},{0.0213623,0.0201416,0.0157166},{0.0214233,0.0201569,0.0157013},
	{0.0215149,0.0202179,0.0156555},{0.0215302,0.0202942,0.0156555},{0.0214996,0.0203705,0.0157013},{0.0215454,0.0204010,0.0156860},
	{0.0216064,0.0204010,0.0156708},{0.0215607,0.0204315,0.0157166},{0.0215149,0.0204315,0.0157471},{0.0216064,0.0203857,0.0157013},
	{0.0216675,0.0203552,0.0156250},{0.0216217,0.0203400,0.0156250},{0.0215454,0.0203094,0.0156555},{0.0214844,0.0202942,0.0156403},
	{0.0214844,0.0202332,0.0155945},{0.0214844,0.0201874,0.0155258},{0.0214233,0.0201569,0.0154648},{0.0213165,0.0201416,0.0154419},
	{0.0212250,0.0200958,0.0154266},{0.0212097,0.0200195,0.0153580},{0.0212097,0.0199127,0.0152740},{0.0211487,0.0198517,0.0152054},
	{0.0210571,0.0198517,0.0151367},{0.0209808,0.0198059,0.0150909},{0.0209656,0.0196838,0.0150833},{0.0209045,0.0195923,0.0150833},
	{0.0208282,0.0195465,0.0150604},{0.0207825,0.0195312,0.0149841},{0.0207520,0.0195007,0.0149155},{0.0206909,0.0194550,0.0148773},
	{0.0205994,0.0194702,0.0148163},{0.0205383,0.0194702,0.0147705},{0.0205078,0.0193634,0.0147858},{0.0205231,0.0193176,0.0147324},
	{0.0205078,0.0193024,0.0146561},{0.0204773,0.0192413,0.0146790},{0.0204163,0.0191650,0.0147018},{0.0204010,0.0191650,0.0146027},
	{0.0204010,0.0191498,0.0144958},{0.0203400,0.0191040,0.0144730},{0.0202484,0.0190735,0.0144882},{0.0201874,0.0190430,0.0144806},
	{0.0201874,0.0189972,0.0144348},{0.0201874,0.0189514,0.0144043},{0.0201263,0.0189514,0.0144043},{0.0200806,0.0189514,0.0143814},
	{0.0201263,0.0189056,0.0143127},{0.0201263,0.0188599,0.0142822},{0.0200500,0.0188141,0.0143204},{0.0199738,0.0187836,0.0143356},
	{0.0199890,0.0188141,0.0142212},{0.0200195,0.0188446,0.0141068},{0.0200043,0.0188293,0.0140762},{0.0200348,0.0187531,0.0140915},
	{0.0200500,0.0186920,0.0141068},{0.0199890,0.0186615,0.0141602},{0.0198822,0.0186768,0.0142288},{0.0198059,0.0186920,0.0142517},
	{0.0197754,0.0187378,0.0142059},{0.0197906,0.0187683,0.0141068},{0.0198822,0.0187683,0.0139771},{0.0199890,0.0187073,0.0139160},
	{0.0200043,0.0186462,0.0139694},{0.0199738,0.0186157,0.0140533},{0.0199585,0.0186157,0.0140762},{0.0200043,0.0186615,0.0140381},
	{0.0200348,0.0186920,0.0140152},{0.0200043,0.0187225,0.0140533},{0.0199280,0.0187531,0.0140991},{0.0199127,0.0187988,0.0140915},
	{0.0199585,0.0187988,0.0140686},{0.0199738,0.0187988,0.0140839},{0.0199585,0.0188293,0.0141068},{0.0200195,0.0188751,0.0140839},
	{0.0201721,0.0188599,0.0140457},{0.0202942,0.0188293,0.0140381},{0.0202942,0.0189056,0.0140610},{0.0202484,0.0189667,0.0141525},
	{0.0202484,0.0189667,0.0142593},{0.0203247,0.0190430,0.0142288},{0.0204163,0.0191498,0.0141678},{0.0204926,0.0191803,0.0142136},
	{0.0205841,0.0191498,0.0143127},{0.0206146,0.0192261,0.0143814},{0.0206604,0.0193176,0.0144272},{0.0207520,0.0193939,0.0144424},
	{0.0207977,0.0194855,0.0144730},{0.0208130,0.0195618,0.0145569},{0.0209045,0.0196381,0.0145721},{0.0210419,0.0197449,0.0145340},
	{0.0211792,0.0198517,0.0145264},{0.0213165,0.0199432,0.0145569},{0.0214539,0.0200195,0.0146332},{0.0215302,0.0200806,0.0148010},
	{0.0215912,0.0201569,0.0150223},{0.0217133,0.0202332,0.0151672},{0.0219574,0.0203247,0.0152054},{0.0221405,0.0204926,0.0151978},
	{0.0222626,0.0207214,0.0152283},{0.0224304,0.0209045,0.0152664},{0.0225677,0.0211029,0.0153580},{0.0226440,0.0212860,0.0155487},
	{0.0228271,0.0214386,0.0157013},{0.0231018,0.0215759,0.0157928},{0.0233459,0.0216827,0.0159760},{0.0235901,0.0218811,0.0161133},
	{0.0238647,0.0221863,0.0160828},{0.0241089,0.0224609,0.0161133},{0.0242767,0.0226135,0.0163269},{0.0244293,0.0227203,0.0166016},
	{0.0245514,0.0227814,0.0169373},{0.0247345,0.0229340,0.0171661},{0.0251312,0.0233307,0.0170135},{0.0255585,0.0238037,0.0168152},
	{0.0258636,0.0242004,0.0169373},{0.0261536,0.0244751,0.0173187},{0.0265503,0.0245667,0.0178375},{0.0269623,0.0246735,0.0184174},
	{0.0273743,0.0251160,0.0187531},{0.0278625,0.0257721,0.0188141},{0.0284729,0.0263672,0.0189209},{0.0291443,0.0269470,0.0191040},
	{0.0297699,0.0275116,0.0194550},{0.0303497,0.0279694,0.0201111},{0.0310516,0.0285339,0.0207062},{0.0319519,0.0294495,0.0209351},
	{0.0328674,0.0304413,0.0212708},{0.0337830,0.0312805,0.0220184},{0.0347900,0.0320129,0.0229950},{0.0359802,0.0329285,0.0239868},
	{0.0373535,0.0342102,0.0248718},{0.0390320,0.0358582,0.0255280},{0.0410461,0.0378723,0.0260773},{0.0432434,0.0398254,0.0270996},
	{0.0455017,0.0418091,0.0287628},{0.0479126,0.0440063,0.0307770},{0.0506897,0.0463867,0.0329590},{0.0539856,0.0492249,0.0349121},
	{0.0577087,0.0525208,0.0365601},{0.0617065,0.0557556,0.0383911},{0.0655518,0.0589905,0.0403442},{0.0686646,0.0625610,0.0422363},
	{0.0708008,0.0656128,0.0444336},{0.0725098,0.0673828,0.0464172},{0.0749512,0.0673828,0.0468140},{0.0773926,0.0661621,0.0449829},
	{0.0759888,0.0657959,0.0423279},{0.0690918,0.0662231,0.0410767},{0.0603943,0.0633545,0.0426025},{0.0592346,0.0535583,0.0431519},
	{0.0679932,0.0467224,0.0336609},{0.0703125,0.0519714,0.0245056},{0.0632935,0.0601196,0.0299530},{0.0586853,0.0635376,0.0466003},
	{0.0676270,0.0654907,0.0578308},{0.0867920,0.0755005,0.0516052},{0.0911865,0.0840454,0.0563660},{0.0897827,0.0853882,0.0633545},
};
static const uint miedl = sizeof(mied)/sizeof(mied[0]);

inline void SamplingBasis(const sfloat4 &iv, sfloat4 *pb1, sfloat4 *pb2){
    //TODO: should probably handle zero-cases
    pb1->v[0] = -iv.v[2];
    pb1->v[1] = sfloat1::zero();
    pb1->v[2] = iv.v[0];
    pb1->v[3] = sfloat1::zero();
    *pb1 /= sfloat4::length3(iv.swizzle<0,3,2,3>()); //assume iv.w to be zero
    *pb2 = sfloat4::cross3(iv,*pb1);
}

namespace KernelSampler{

PhaseFunction::PhaseFunction(){
	//
}

PhaseFunction::~PhaseFunction(){
	//
}

HGPhase::HGPhase(float _g) : g1(_g){
	//
}

HGPhase::~HGPhase(){
	//
}

sfloat1 HGPhase::Evaluate(const sfloat1 &ct) const{
    sfloat1 g = sfloat1(g1);
    sfloat1 e = sfloat1(1.50f);
    return (1.0f-g*g)/(4.0f*SM_PI*sfloat1::pow(1.0f+g*g-2.0f*g*ct,e));
}

sfloat4 HGPhase::Sample(const sfloat4 &iv, const sfloat1 &u1, const sfloat1 &u2) const{
    sfloat1 g = sfloat1(g1);
    sfloat1 sq = (1.0f-g*g)/(1.0f-g+2.0f*g*u1);
    sfloat1 ct = (1.0f+g*g-sq*sq)/(2.0f*g);
    sfloat1 st = sfloat1::sqrt(sfloat1::max(1.0f-ct*ct,sfloat1::zero()));
    sfloat1 ph = 2.0f*SM_PI*u2;

    sfloat4 b1, b2;
    SamplingBasis(iv,&b1,&b2);
    sfloat1 sph, cph;
    sincos_ps(ph.v,&sph.v,&cph.v);
    return b1*st*cph+b2*st*sph+iv*ct;
}

HGPhase HGPhase::ghg(0.35f); //also panel.py description

MiePhase::MiePhase(){
	//
}

MiePhase::~MiePhase(){
	//
}

sfloat1 MiePhase::Evaluate(const sfloat1 &ct) const{
	sfloat1 a = sfloat1::acos(ct)/SM_PI;
	sfloat1 x = sfloat1::floor((float)miedl*a);
	sfloat1 t = a-x;
	dfloatN X = dfloatN(x);
	dfloatN MA, MB;
	for(uint i = 0; i < BLCLOUD_VSIZE; ++i){
		MA.v[i] = mied[(uint)X.v[i]].x;
		MB.v[i] = mied[(uint)X.v[i]+1].x;
	}
	sfloat1 ma = sfloat1::load(&MA);
	sfloat1 mb = sfloat1::load(&MB);

	return sfloat1::lerp(ma,mb,t);
}

sfloat4 MiePhase::Sample(const sfloat4 &iv, const sfloat1 &u1, const sfloat1 &u2) const{
	//rejection sampling
	//Alternative: precomputed CDF: store a table of preintegrated cumulative distributions.
	//Use a partition tree (half-splits) to speed up the lookup.
	return sfloat1(0.0f);
}

MiePhase MiePhase::gmie;

BaseLight::BaseLight(){
	//
}

BaseLight::~BaseLight(){
	//
}

SunLight::SunLight(const dfloat3 *pd, const dfloat3 *pc, float _angle) : direction(*pd), color(*pc), angle(_angle){
	//
}

SunLight::~SunLight(){
	//
}

sfloat4 SunLight::Evaluate(const sfloat4 &rd) const{
	sfloat4 lc = sfloat1::zero();
	sfloat1 lt = sfloat1::Greater(sfloat4::dot3(rd,sfloat4(float4::load(&direction))),sfloat1(angle));

	float4 c = float4::load(&color);
	lc.v[0] = sfloat1::Or(sfloat1::And(lt,c.splat<0>()),sfloat1::AndNot(lt,lc.v[0]));
	lc.v[1] = sfloat1::Or(sfloat1::And(lt,c.splat<1>()),sfloat1::AndNot(lt,lc.v[1]));
	lc.v[2] = sfloat1::Or(sfloat1::And(lt,c.splat<2>()),sfloat1::AndNot(lt,lc.v[2]));

	return lc;
}

sfloat1 SunLight::Pdf(const sfloat4 &iv) const{
	sfloat1 ctm = sfloat1::sqrt(1.0f-angle*angle);
    return sfloat1(1.0f/(2.0f*SM_PI*(1.0f-ctm)));
}

sfloat4 SunLight::Sample(const sfloat4 &iv, const sfloat1 &u1, const sfloat1 &u2) const{
	//iv: light vector in this case
    //t = asin(theta = r/d)
    //cos(asin(t)) = sqrt(1-(r/d)^2)
    //sfloat1 u1 = RNG_Sample(prs);
    sfloat1 ctm = sfloat1::sqrt(1.0f-angle*angle);
    sfloat1 ct = (1.0f-u1)+u1*ctm;
    sfloat1 st = sfloat1::sqrt(1.0f-ct*ct);
    sfloat1 ph = 2.0f*SM_PI*u2;

    sfloat4 b1, b2;
    SamplingBasis(iv,&b1,&b2);
    sfloat1 sph, cph;
    sincos_ps(ph.v,&sph.v,&cph.v);
    return b1*st*cph+b2*st*sph+iv*ct;
}

}
